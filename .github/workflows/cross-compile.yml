name: Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  linux-x64:
    name: linux-x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build rstil
        run: make rstil
      - name: Create test tmp directory
        run: mkdir -p tmp
      - name: Run tests
        run: make tests
      - name: Test build
        run: |
          ./bin/rstil build src/examples/hello_script.til --target=linux-x64
          ./bin/examples/hello_script

  linux-arm64:
    name: linux-arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
      - name: Build rstil
        run: make rstil
      - name: Create test tmp directory
        run: mkdir -p tmp
      - name: Run tests
        run: make tests
      - name: Test cross-compile
        run: |
          ./bin/rstil build src/examples/hello_script.til --target=linux-arm64
          file src/examples/bin/hello_script | grep -q "aarch64"

  linux-riscv64:
    name: linux-riscv64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-riscv64-linux-gnu
      - name: Build rstil
        run: make rstil
      - name: Create test tmp directory
        run: mkdir -p tmp
      - name: Run tests
        run: make tests
      - name: Test cross-compile
        run: |
          ./bin/rstil build src/examples/hello_script.til --target=linux-riscv64
          file src/examples/bin/hello_script | grep -q "RISC-V"

  windows-x64:
    name: windows-x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cross-compiler
        run: sudo apt-get update && sudo apt-get install -y mingw-w64
      - name: Build rstil
        run: make rstil
      - name: Create test tmp directory
        run: mkdir -p tmp
      - name: Run tests
        run: make tests
      - name: Test cross-compile
        run: |
          ./bin/rstil build src/examples/hello_script.til --target=windows-x64
          test -f src/examples/bin/hello_script.exe

  macos-x64:
    name: macos-x64
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - name: Build rstil
        run: make rstil
      - name: Create test tmp directory
        run: mkdir -p tmp
      - name: Run tests
        run: make tests
      - name: Test build
        run: |
          ./bin/rstil build src/examples/hello_script.til --target=macos-x64
          ./bin/examples/hello_script

  macos-arm64:
    name: macos-arm64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build rstil
        run: make rstil
      - name: Create test tmp directory
        run: mkdir -p tmp
      - name: Run tests
        run: make tests
      - name: Test build
        run: |
          ./bin/rstil build src/examples/hello_script.til --target=macos-arm64
          ./bin/examples/hello_script

