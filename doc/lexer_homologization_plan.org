#+TITLE: Lexer Homologization - Detailed Plan
#+AUTHOR: Week 1 of Self-Hosting
#+DATE: 2025-01-08

* Overview

Goal: Achieve 100% functional parity between lexer.til and src/rs/lexer.rs, with bidirectional improvements.

Current Status: 95% complete - READY to homologize

* Current Differences

** Size
- lexer.til: 712 lines (138% of Rust)
- lexer.rs: 517 lines
- Reason: TIL is more verbose due to explicit if/switch vs Rust's pattern matching

** Functional Parity
- Both support: nested comments, string escapes, reserved words, dotted numbers
- TIL advantage: Better error messages with suggestions
- Rust advantage: More concise code

** Key Files
- =src/core/lexer.til= (TIL implementation)
- =src/rs/lexer.rs= (Rust implementation)

* Detailed Tasks

** Task 1: Backport Error Messages (TIL → Rust)
*** Goal
Copy helpful error messages from lexer.til to lexer.rs for better user experience

*** Specific Changes in lexer.rs

**** Change 1: Reserved Word Error Messages
File: =src/rs/lexer.rs=
Lines: ~370-400 (scan_reserved_word function)

Current behavior:
#+BEGIN_SRC rust
// Just returns error for forbidden words
return Err(format!("'{}' is forbidden", word));
#+END_SRC

New behavior (from lexer.til lines 605-670):
#+BEGIN_SRC rust
// Provide helpful suggestions
match word {
    "fn" => return Err(format!("'fn' is forbidden. Use 'func' instead")),
    "var" => return Err(format!("'var' is forbidden. Use 'mut' instead")),
    "let" => return Err(format!("'let' is forbidden. Use ':=' for declaration")),
    "const" => return Err(format!("'const' is forbidden. Variables are immutable by default")),
    "class" => return Err(format!("'class' is forbidden. Use 'struct' instead")),
    "interface" => return Err(format!("'interface' is forbidden. TIL doesn't have interfaces")),
    "implements" => return Err(format!("'implements' is forbidden")),
    "extends" => return Err(format!("'extends' is forbidden")),
    "public" | "private" | "protected" => return Err(format!("'{}' is forbidden. TIL doesn't have visibility modifiers", word)),
    _ => return Err(format!("'{}' is forbidden", word)),
}
#+END_SRC

Specific lines to modify:
- Find =scan_reserved_word= function
- Replace simple error with match expression with suggestions
- Copy exact messages from lexer.til lines 605-670

*** Testing
- Run: =cargo test lexer= (should still pass)
- Test manually with forbidden words: =fn=, =var=, =let=, =const=, =class=
- Verify error messages include suggestions

*** Success Criteria
- [ ] All forbidden words return helpful error messages
- [ ] Tests pass
- [ ] Manual testing confirms better UX

** Task 2: Reduce TIL Verbosity (TIL Code Simplification)
*** Goal
Make lexer.til more concise by using switch pattern matching where possible

*** Specific Changes in lexer.til

**** Change 1: Simplify scan_token dispatcher
File: =src/core/lexer.til=
Lines: ~150-300

Current (verbose with many if statements):
#+BEGIN_SRC til
if c.eq("(") {
    self.add_token(TokenType.LeftParen, "(")
}
if c.eq(")") {
    self.add_token(TokenType.RightParen, ")")
}
// ... many more if statements
#+END_SRC

Improved (using switch):
#+BEGIN_SRC til
switch c {
case "(":
    self.add_token(TokenType.LeftParen, "(")
case ")":
    self.add_token(TokenType.RightParen, ")")
case "{":
    self.add_token(TokenType.LeftBrace, "{")
case "}":
    self.add_token(TokenType.RightBrace, "}")
// ... continue pattern
case:
    // Default case for complex scanning
}
#+END_SRC

Specific sections to simplify:
- Lines ~150-300: Single-character tokens (use switch)
- Lines ~300-400: Multi-character operators (keep as is, needs lookahead)
- Lines ~400-500: String/number scanning (keep as is, complex logic)

**** Change 2: Simplify character classification
File: =src/core/lexer.til=
Lines: ~100-140

Current uses multiple if statements for character type checking.
Consider: Keep as is (readable) or consolidate with switch if clearer.

*** Testing
- Run: =make= (all tests should pass)
- Compare token output with Rust lexer on same input files
- Verify line count reduced (target: 650-680 lines, down from 712)

*** Success Criteria
- [ ] Code is more readable and concise
- [ ] All tests pass
- [ ] Token output identical to before changes
- [ ] Line count reduced by ~30-60 lines

** Task 3: Validate Equivalence
*** Goal
Ensure both lexers produce identical token streams for the same input

*** Test Cases to Validate

**** Test File 1: Basic Tokens
Create =test_inputs/lexer_test_basic.til=:
#+BEGIN_SRC til
// Test basic tokens
func hello() {
    println("Hello, World!")
    x := 42
    mut y := true
}
#+END_SRC

Expected tokens (both lexers should match):
- FUNC, IDENTIFIER("hello"), LPAREN, RPAREN, LBRACE
- IDENTIFIER("println"), LPAREN, STRING("Hello, World!"), RPAREN
- IDENTIFIER("x"), COLONEQUALS, NUMBER("42")
- MUT, IDENTIFIER("y"), COLONEQUALS, TRUE
- RBRACE

**** Test File 2: Forbidden Words
Create =test_inputs/lexer_test_forbidden.til=:
#+BEGIN_SRC til
fn test() {}  // Should error with suggestion
var x = 5     // Should error with suggestion
#+END_SRC

Expected: Error messages with helpful suggestions

**** Test File 3: Complex Constructs
Create =test_inputs/lexer_test_complex.til=:
#+BEGIN_SRC til
/* Nested /* comments */ work */
str := "escape\nsequence\t\"quoted\""
num := 3.14159
range := 0..10
#+END_SRC

Expected tokens (verify nested comments, escapes, dotted numbers, range operator)

*** Validation Script
Create =scripts/validate_lexer.sh=:
#+BEGIN_SRC bash
#!/bin/bash
# Compare Rust and TIL lexer output

echo "Testing lexer equivalence..."

# Test 1: Basic tokens
echo "Test 1: Basic tokens"
./bin/rstil --lex test_inputs/lexer_test_basic.til > /tmp/rust_lex.txt
./bin/rstil --lex-til test_inputs/lexer_test_basic.til > /tmp/til_lex.txt
diff /tmp/rust_lex.txt /tmp/til_lex.txt && echo "PASS" || echo "FAIL"

# Test 2: Forbidden words
echo "Test 2: Forbidden words"
./bin/rstil --lex test_inputs/lexer_test_forbidden.til 2>&1 | grep "Use 'func' instead" && echo "PASS" || echo "FAIL"

# Test 3: Complex constructs
echo "Test 3: Complex constructs"
./bin/rstil --lex test_inputs/lexer_test_complex.til > /tmp/rust_lex2.txt
./bin/rstil --lex-til test_inputs/lexer_test_complex.til > /tmp/til_lex2.txt
diff /tmp/rust_lex2.txt /tmp/til_lex2.txt && echo "PASS" || echo "FAIL"
#+END_SRC

*** Success Criteria
- [ ] All test files produce identical token streams
- [ ] Error messages match (with improvements from Task 1)
- [ ] No regressions in existing tests
- [ ] Validation script passes 100%

** Task 4: Document Differences
*** Goal
Record any intentional differences between implementations

*** Documentation File
Update =doc/self_hosting_progress.org= section "Lexer" with:

#+BEGIN_EXAMPLE
*** Intentional Differences (Post-Homologization)

1. *Code Style*:
   - Rust: Uses pattern matching for conciseness
   - TIL: Uses switch statements (TIL's pattern matching equivalent)
   - Both functionally equivalent

2. *Error Messages*:
   - Both now include helpful suggestions
   - Format may differ slightly due to language constraints

3. *Performance*:
   - Not measured yet
   - Both are fast enough for current needs
   - Future: Consider benchmarking

4. *Dependencies*:
   - Rust: Uses std::collections
   - TIL: Uses custom StrMap (from core)
#+END_EXAMPLE

*** Success Criteria
- [ ] All differences documented
- [ ] Future maintainers understand design decisions
- [ ] No surprises when comparing implementations

** Task 5: Mark Complete
*** Goal
Update tracking document to reflect completion

*** Changes to doc/self_hosting_progress.org

Update lexer section:
#+BEGIN_EXAMPLE
** Lexer (lexer.til vs src/rs/lexer.rs)
*** Status: 100% COMPLETE [X] (Homologized 2025-01-08)

*** Homologization Tasks
- [X] Backport error messages from TIL to Rust (lexer.til lines 605-670)
- [X] Reduce TIL verbosity using switch pattern matching
- [X] Validate token output equivalence with test suite
- [X] Document intentional differences
- [X] Mark complete
#+END_EXAMPLE

Update overall timeline:
#+BEGIN_EXAMPLE
** Week 1: Lexer Homologization
- [X] Create tracking document
- [X] Backport error messages TIL → Rust
- [X] Reduce TIL verbosity
- [X] Validate equivalence
- [X] Mark lexer complete
#+END_EXAMPLE

*** Success Criteria
- [ ] Checkbox [X] for all lexer tasks
- [ ] Status shows "100% COMPLETE"
- [ ] Timeline shows Week 1 complete
- [ ] Ready to move to Week 2-4 (fix blockers)

* Timeline

| Day | Task                                   | Hours | Status |
|-----+----------------------------------------+-------+--------|
|   1 | Backport error messages to Rust        |   2-3 | [ ]    |
|   2 | Simplify TIL code with switch          |   3-4 | [ ]    |
|   3 | Create test cases                      |   2-3 | [ ]    |
|   4 | Run validation tests                   |   1-2 | [ ]    |
|   5 | Fix any issues found                   |   2-3 | [ ]    |
|   6 | Document differences                   |   1-2 | [ ]    |
|   7 | Update tracking doc and celebrate      |     1 | [ ]    |
|-----+----------------------------------------+-------+--------|
|     | *Total*                                | *14*  |        |

Estimated: 1 week (14 hours of focused work)

* Success Criteria Summary

Lexer homologization is COMPLETE when:

- [X] Both lexers at feature parity (95% → 100%)
- [ ] Rust has better error messages (backported from TIL)
- [ ] TIL has reduced verbosity (more concise)
- [ ] Token output validated as identical
- [ ] All tests pass in both implementations
- [ ] Intentional differences documented
- [ ] Tracking document updated with completion checkboxes

* Next Steps

After lexer completion:
1. Move to Weeks 2-4: Fix critical blockers (enum payload bug, tagged unions)
2. Then: Parser homologization (Week 5)
3. Reference this plan as template for other components

* Notes

- Created: 2025-01-08
- Status: Planning complete, ready to execute
- Owner: Self-hosting team
- Priority: HIGH (first step in homologization)
