#+TITLE: Pre-Self-Hosting TODO List
#+AUTHOR: rstil Development
#+DATE: 2025-01-09

* Overview

This document tracks TODOs in the *Rust implementation (rstil)* that must be completed before the self-hosted til interpreter can run successfully.

*Current Status:* All documented bugs fixed (see [[file:rstil_bugs.md][rstil_bugs.md]]), but missing features and test gaps remain.

*Scope:* This focuses on rstil (Rust) implementation issues, NOT on completing the til-based interpreter/typer/etc.

* Progress Summary

| Component           | Status                          | Notes                                           |
|---------------------+---------------------------------+-------------------------------------------------|
| Known Bugs          | ✅ BUG #6 FIXED                 | Enum payloads now reserve max variant size      |
| Error Handling      | ✅ WORKING                      | throw/throws/catch fully functional             |
| Import System       | ✅ WORKING                      | Basic imports work in all modes                 |
| Test Suite          | ⚠️ PARTIALLY BLOCKED            | test_parser.til blocked by arena size issue     |
| Type System         | ✅ ENUM-AS-PAYLOAD WORKS        | Direct construction now supported               |
| Parser Homogenization | ⚠️ 85% COMPLETE                | Phases 0-3 done, blocked by arena size bug      |

* Critical: Missing rstil Features
:PROPERTIES:
:CATEGORY: Missing Features
:END:

** DONE Support Recursive Enum Payloads (enums as payloads)              :HIGH:
CLOSED: [2025-01-09]
:PROPERTIES:
:DISCOVERED: 2025-01-09
:FIXED: 2025-01-09
:IMPACT: Was blocking parser homogenization completion
:RELATED: Parser homogenization, Type system
:END:

*** Problem (FIXED)
TIL did not support using enum constructors directly as payloads for other enums.
This was required for proper parser data structures in parser.til.

Example that now works:
#+BEGIN_SRC til
FunctionType := enum {
    FTFunc,
    FTProc,
}

ValueType := enum {
    TFunction: FunctionType,  // Enum as payload - NOW WORKS
    TCustom: Str,             // Primitive as payload - WORKS
}

// This now works:
vt := ValueType.TFunction(FunctionType.FTFunc)  // Direct constructor as payload
ft := FunctionType.FTFunc
vt2 := ValueType.TFunction(ft)                  // Identifier as payload (already worked)
#+END_SRC

*** Solution
Fixed in interpreter.rs:
- Line 607: Check if Identifier has params before treating as variable name
- Line 615: Use eval_expr instead of eval_func_proc_call to handle both FCall and Identifier nodes
- Line 1118: Added safety check to prevent get_enum on type names

*** Remaining Issue
test_parser.til still crashes with "range end index out of bounds" in get_enum_at_offset.
This is a separate arena size calculation issue when passing enums with enum payloads to functions.
See new TODO below.

** TODO Improve Forward Reference Error Messages                         :MEDIUM:
:PROPERTIES:
:DISCOVERED: 2025-01-09
:IMPACT: Developer experience, debugging
:END:

*** Problem
When an enum references another enum that hasn't been defined yet (forward reference),
rstil gives an unclear error message at runtime instead of a clear parse-time error.

Example:
#+BEGIN_SRC til
ValueType := enum {
    TFunction: FunctionType,  // Forward reference - FunctionType not defined yet
}

FunctionType := enum {
    FTFunc,
    FTProc,
}
#+END_SRC

Current error (at runtime):
: get_enum: 'FunctionType' is not a custom enum type

Better error (at parse time):
: Forward reference: 'FunctionType' used in ValueType definition before being defined
: Hint: Move FunctionType definition before ValueType

*** What's Needed
- [ ] Add forward reference detection in parser.rs during enum definition parsing
- [ ] Provide clear error message with line numbers and helpful suggestion
- [ ] Document enum definition ordering requirements in language docs

*** Workaround
Manually ensure enum definitions are in dependency order (dependencies defined first).

* Critical: Missing rstil Features (Continued)
:PROPERTIES:
:CATEGORY: Missing Features
:END:

** TODO Fix Arena Size Calculation for Enum Payloads                 :HIGH:
:PROPERTIES:
:FILE: src/tests.til:45-49
:IMPACT: test_parser.til crashes when passing enums with enum payloads to functions
:DISCOVERED: 2025-01-09
:END:

*** Current State
- =src/test/test_lexer.til= - ✅ WORKING
- =src/test/test_parser.til= - ⚠️ CRASHES with "range end index out of bounds" in get_enum_at_offset

*** Problem
When an enum with an enum payload is passed to a function, rstil crashes trying to read
past the end of the arena. The error occurs in init.rs:1497 in get_enum_at_offset.

Example that crashes:
#+BEGIN_SRC til
import("src/core/parser")
vt := ValueType.TFunction  // ValueType has FunctionType as payload
result := value_type_to_str(vt)  // Crashes here with "range end index 672 out of range for slice of length 664"
#+END_SRC

*** Root Cause
The arena doesn't allocate enough space for enums that have other enums as payloads.
When get_enum_at_offset tries to read the payload at offset+8, it goes past the allocated memory.

This is different from the enum-as-payload construction issue (which is now fixed).
Direct construction works: =ValueType.TFunction(FunctionType.FTFunc)= ✅
Passing to functions fails: =some_func(vt)= where vt has an enum payload ❌

*** What's Needed
- [ ] Fix arena size calculation in insert_enum to reserve max variant size including enum payloads
- [ ] Ensure get_enum_at_offset correctly reads enum payloads from arena
- [ ] Re-enable test_parser.til after fix

*** Why This Matters
Parser.til uses ValueType extensively with enum payloads. This blocks all parser tests.

* High Priority: Known Bugs & Workarounds
:PROPERTIES:
:CATEGORY: Bugs
:END:

** TODO Remove Workarounds for Fixed Enum Bugs                        :HIGH:
:PROPERTIES:
:FILE: src/core/parser.til:239, src/core/parser.til:320
:STATUS: Bugs fixed, workarounds still in code
:END:

*** Current State
All enum bugs are FIXED (see rstil_bugs.md), but workarounds remain:
- =src/core/parser.til:239= - "Workaround for rstil bug - enum payloads must be variables"
- =src/core/parser.til:320= - Same workaround repeated
- =src/core/lexer.til:586= - "Workaround for rstil bug - return in methods returns from caller"

*** Action Required
- [ ] Verify bugs are truly fixed by testing without workarounds
- [ ] Remove workaround code from parser.til (lines 239, 320)
- [ ] Test direct nested enum construction works
- [ ] Remove return workaround from lexer.til if bug #2 confirmed fixed
- [ ] Update comments to reference historical bug fixes

*** Why This Matters
Workarounds add complexity and may hide issues. Clean code is easier to maintain during self-hosting transition.

* References

- [[file:rstil_bugs.md][rstil_bugs.md]] - Fixed bugs (all resolved as of Jan 2025)
- [[file:self_hosting_progress.org][self_hosting_progress.org]] - Component completion status
- [[file:design_notes.org][design_notes.org]] - Language design decisions
- [[file:../src/tests.til][src/tests.til]] - Test suite with disabled tests marked
- [[file:../src/test/todo.til][src/test/todo.til]] - Additional language TODOs

* Notes

** Focus on rstil, Not til Implementation
This document tracks what the *Rust interpreter (rstil)* needs to support self-hosting.

Completing interpreter.til, typer.til, etc. is a separate concern - those are the GOAL of self-hosting, not prerequisites.

** Workarounds Are Okay Temporarily
Some workarounds (like PatternInfo for tuples) are acceptable short-term. The priority is getting rstil stable enough to run the self-hosted code, even if that code has workarounds.

