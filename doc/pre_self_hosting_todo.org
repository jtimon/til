#+TITLE: Pre-Self-Hosting TODO List
#+AUTHOR: rstil Development
#+DATE: 2025-01-09

* Overview

This document tracks TODOs in the *Rust implementation (rstil)* that must be completed before the self-hosted til interpreter can run successfully.

*Current Status:* All documented bugs fixed (see [[file:rstil_bugs.md][rstil_bugs.md]]), but missing features and test gaps remain.

*Scope:* This focuses on rstil (Rust) implementation issues, NOT on completing the til-based interpreter/typer/etc.

* Progress Summary

| Component           | Status                          | Notes                                  |
|---------------------+---------------------------------+----------------------------------------|
| Known Bugs          | ✅ ALL FIXED                    | See rstil_bugs.md                      |
| Error Handling      | ✅ WORKING                      | throw/throws/catch fully functional    |
| Import System       | ✅ WORKING                      | Basic imports work in all modes        |
| Test Suite          | ⚠️ 2 TESTS DISABLED             | Missing throws declarations            |
| Type System         | ⚠️ MINOR GAPS                   | Variadic args, some edge cases         |

* Critical: Missing rstil Features
:PROPERTIES:
:CATEGORY: Missing Features
:END:

** TODO Add Optional Error Handling Enhancements                      :LOW:
:PROPERTIES:
:FILE: src/rs/typer.rs:1212, src/test/errors.til
:STATUS: Core system working, optional features could be added
:END:

*** Current State - Core System Working
Error handling is FULLY FUNCTIONAL:
- =throw= keyword works
- =throws= declarations work and are type-checked
- =catch= blocks work with multiple catch types
- Type checker enforces throws propagation
- All tests in =src/test/errors.til= pass

*** What Works
#+BEGIN_SRC til
// Throw and catch
MyError := struct { msg: Str = "error" }

risky := func() throws MyError {
    throw MyError()
}

safe := proc() {
    risky()
    catch (e: MyError) {
        println("Caught: ", e.msg)
    }
}
#+END_SRC

- Throwing custom error types (any struct)
- Multiple catch blocks for different error types
- Throws propagation checking (must declare or catch)
- Error structs with fields

*** Optional Enhancements (Not Needed for Self-Hosting)
See =src/test/errors.til= for detailed TODO examples:
- [ ] PanicError - implicit error type (src/rs/typer.rs:1212)
- [ ] Result<T, E> type (Rust-style explicit errors)
- [ ] Rethrow keyword
- [ ] Try operator (? for auto-propagation)
- [ ] Finally blocks for cleanup
- [ ] Better error messages with backtraces

*** Why This Isn't Blocking
The current throw/throws/catch system is complete and sufficient for self-hosting. The optional enhancements are nice-to-haves that can be added later.

** TODO Fix Disabled Test Files                                      :HIGH:
:PROPERTIES:
:FILE: src/tests.til:44-46, src/tests.til:61
:IMPACT: test_lexer.til and test_parser.til disabled
:END:

*** Current State
- =src/tests.til:44-46= - test_lexer.til and test_parser.til disabled (claimed "mode inheritance issues" but actually other problems)
- =src/tests.til:61= - errors.til test file commented out: "TODO implement, throw, throws and catch"
- Import system itself works fine in lib mode (tested and verified)

*** Actual Issues
1. test_lexer.til fails due to missing =throws= declarations in function signatures (24 type errors)
2. test_parser.til fails due to broken assertions (e.g., line 121 expects 'foo', finds 'Expr')
3. errors.til blocked by incomplete throw/throws/catch implementation

*** What's Needed
- [ ] Add =throws= declarations to functions in lexer.til that can throw errors
- [ ] Fix broken assertions in test_parser.til (update expected values)
- [ ] Re-enable test_lexer.til and test_parser.til in src/tests.til
- [ ] Complete throw/throws/catch implementation to enable errors.til

*** Why This Matters
These tests exercise critical lexer/parser functionality needed for self-hosting.

* High Priority: Known Bugs & Workarounds
:PROPERTIES:
:CATEGORY: Bugs
:END:

** TODO Remove Workarounds for Fixed Enum Bugs                        :HIGH:
:PROPERTIES:
:FILE: src/core/parser.til:239, src/core/parser.til:320
:STATUS: Bugs fixed, workarounds still in code
:END:

*** Current State
All enum bugs are FIXED (see rstil_bugs.md), but workarounds remain:
- =src/core/parser.til:239= - "Workaround for rstil bug - enum payloads must be variables"
- =src/core/parser.til:320= - Same workaround repeated
- =src/core/lexer.til:586= - "Workaround for rstil bug - return in methods returns from caller"

*** Action Required
- [ ] Verify bugs are truly fixed by testing without workarounds
- [ ] Remove workaround code from parser.til (lines 239, 320)
- [ ] Test direct nested enum construction works
- [ ] Remove return workaround from lexer.til if bug #2 confirmed fixed
- [ ] Update comments to reference historical bug fixes

*** Why This Matters
Workarounds add complexity and may hide issues. Clean code is easier to maintain during self-hosting transition.

* References

- [[file:rstil_bugs.md][rstil_bugs.md]] - Fixed bugs (all resolved as of Jan 2025)
- [[file:self_hosting_progress.org][self_hosting_progress.org]] - Component completion status
- [[file:design_notes.org][design_notes.org]] - Language design decisions
- [[file:../src/tests.til][src/tests.til]] - Test suite with disabled tests marked
- [[file:../src/test/todo.til][src/test/todo.til]] - Additional language TODOs

* Notes

** Focus on rstil, Not til Implementation
This document tracks what the *Rust interpreter (rstil)* needs to support self-hosting.

Completing interpreter.til, typer.til, etc. is a separate concern - those are the GOAL of self-hosting, not prerequisites.

** Workarounds Are Okay Temporarily
Some workarounds (like PatternInfo for tuples) are acceptable short-term. The priority is getting rstil stable enough to run the self-hosted code, even if that code has workarounds.

