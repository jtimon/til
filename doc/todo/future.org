#+TITLE: Future Language Design Decisions
#+AUTHOR: TIL Development
#+DATE: 2025-12-31
# BOT: Issues here use same numbering as bugs.org (from doc/todo/next_issue_num.txt)

* Overview

This document tracks long-term language design decisions that are not bugs
but need consideration. Unlike bugs.org (specific problems to fix), these
are open questions about language direction.

* Open Issues

** Issue #66: Variable Shadowing Policy
:PROPERTIES:
:DISCOVERED: 2025-12-31
:IMPACT: Language design, Rust/TIL parity, developer experience
:STATUS: Open
:RELATED: Bug #65 (specific shadowing divergence)
:END:

*** Background
Bug #65 was caused by Rust code using variable shadowing (~let custom_type_name = ...~
to shadow an existing variable), but TIL doesn't support shadowing, so the TIL
translation used a different variable name (~resolved_type_name~) and then
inconsistently used the old name later.

*** Current Behavior (Tested 2025-11-10)

1. *~_~ reuse in same scope*: ALLOWED
   - ~_ := 5~ followed by ~_ := 10~ works
   - Universal in all languages - ~_~ is special

2. *Regular variable same-scope shadowing*: ALLOWED
   - ~x := 5~ followed by ~x := 10~ works
   - Creates new binding, not reassignment

3. *Type-change shadowing*: NOT ALLOWED
   - ~y := 5~ followed by ~y := "hello"~ fails type checking
   - Treated as reassignment to existing variable

4. *Nested-scope shadowing*: PARTIALLY WORKS (buggy)
   - Inner ~z := 10~ is allowed after outer ~z := 5~
   - BUT: Inner declaration MUTATES outer variable
   - This is likely a bug - should create new binding

*** Decision Needed

Options:
1. *Allow full shadowing like Rust* (including type changes)
   - Pro: 1:1 translation from Rust to TIL
   - Pro: Familiar to Rust developers
   - Con: Can hide bugs (accidentally reusing variable name)

2. *Prohibit same-scope shadowing like Go/Haskell* (except for ~_~)
   - Pro: Clearer code, no hidden rebinding
   - Con: Rust code needs different variable names when porting

3. *Current inconsistent behavior* (not recommended)
   - Pro: None
   - Con: Confusing, leads to bugs like Bug #65

*** Interim Rule (Until Decided)

To avoid Rust/TIL divergence like Bug #65:
- *Avoid shadowing in Rust code* - use different variable names
- *Use ~resolved_X~ pattern* - when transforming a variable, use a new name
- *-Wshadow enabled* - gcc warns about shadowing in generated C code

This rule is documented in CLAUDE.md.

*** Action Items
- [ ] Fix nested-scope shadowing bug (high priority)
- [ ] Evaluate shadowing usage in self-hosted codebase
- [ ] Choose consistent shadowing policy
- [ ] Implement in type checker
- [ ] Document decision

*** References
- Bug #65: Specific instance where shadowing caused divergence
- doc/todo/post.org: Original shadowing discussion (moved here)

** Issue #69: Test Organization - all_common category
:PROPERTIES:
:DISCOVERED: 2025-12-31
:IMPACT: Test infrastructure, rstil/til output validation
:STATUS: Implemented
:RELATED: bug50 (rstil vs til prefix mismatch)
:END:

*** Background
Tests that pass with BOTH rstil and til (with identical output) need a category
that runs all modes. Previously tests were either in ~rs_common~ (rstil only)
or ~til_interpreted~ (til only), with no way to verify identical behavior.

*** Solution Implemented
Added ~all_common~ category in tests.til that runs 4 modes:
- rs_interpreted (rstil interpret)
- rs_compiled (rstil run)
- til_interpreted (til interpret)
- til_compiled (til run)

Currently empty - ~til run~ segfaults on all tests (self-hosted compiler broken).
When ~til run~ starts working, tests can be promoted from ~rs_common~.

*** Test Categorization Strategy
- ~all_common~: Tests producing identical output across all 4 modes (currently empty)
- ~rs_common~: Tests that pass with rstil (67 tests)
- ~til_interpreted~: Tests that pass with til interpret (47 tests)
  - 46 tests are in BOTH rs_common and til_interpreted (duplicated for validation)
  - 1 test (empty.til) is til-only
- ~rs_interpreted~, ~rs_compiled~: Mode-specific tests
- Empty categories are skipped in benchmark output

*** Example: bug50
bug50.til produces ~rstil type ERROR~ vs ~til type ERROR~ (binary name in output).
It stays in ~rs_common~ until either:
1. Binary name removed from error messages, OR
2. Output normalization added to test comparison

*** Benchmark Annotations
4-phase all_common tests will show timing comparisons:
- ~(rstil: faster interpreted)~ or ~(rstil: faster compiled)~ - comparing rstil modes
- ~(interpreted: faster rstil)~ or ~(interpreted: faster til)~ - comparing interpreters
- ~(compiled: faster rstil)~ or ~(compiled: faster til)~ - comparing compilers

*** Files Modified
- src/tests.til: Added all_common Vec, processing in run_all_tests(), updated usage()
