* TIL Migration Analysis - Maximizing TIL Code Percentage

** Executive Summary

Current language distribution (by lines of code):
| Language | Lines   | Percentage | Purpose                          |
|----------+---------+------------+----------------------------------|
| C        | 82,789  | 53%        | bootstrap/til.c (82K) + ext.c    |
| TIL      | 48,333  | 31%        | Compiler, libraries, tests       |
| Rust     | 23,831  | 15%        | Bootstrap compiler (rstil)       |
| Total    | 154,953 | 100%       |                                  |

Note: The user-reported 72% C figure likely comes from GitHub linguist which may count
differently or include generated files with different weights.

Key insight: The massive C percentage comes almost entirely from bootstrap/til.c (82K
lines), which is an auto-generated file - the TIL compiler compiled to C. This is not
"real" C code but machine-generated output.

** Current Architecture

*** Translation Chain
#+BEGIN_EXAMPLE
rstil.rs (Rust) --[manual port]--> til.til (TIL) --[compile]--> til.c (C)
#+END_EXAMPLE

Simplifying Rust code directly reduces all three: the Rust implementation, the TIL
port, and the generated C bootstrap.

*** Compilation Pipeline
#+BEGIN_EXAMPLE
TIL Source -> [rstil (Rust)] -> C Code -> [gcc] -> Binary
                                  ^
                                  |
                              + ext.c (multiplatform runtime for compiled mode)
#+END_EXAMPLE

*** Self-Hosting Pipeline (in progress)
#+BEGIN_EXAMPLE
TIL Source -> [rstil_til (TIL via Rust)] -> C Code -> [gcc] -> Binary
#+END_EXAMPLE

Note: til doesn't compile itself yet due to memory issues (copies and leaks memory).

** Analysis by Component

*** 1. Rust Bootstrap Compiler (23,831 lines)

Location: src/rs/*.rs + src/rstil.rs

| Module          | Lines | TIL Port Status | Notes                        |
|-----------------+-------+-----------------+------------------------------|
| ccodegen.rs     | 6,800 | DONE            | ccodegen.til (8,557 lines)   |
| interpreter.rs  | 2,842 | DONE            | interpreter.til (3,204)      |
| typer.rs        | 2,789 | DONE            | typer.til (3,594)            |
| parser.rs       | 1,866 | DONE            | parser.til (2,446)           |
| init.rs         | 1,766 | DONE            | init.til (2,380)             |
| eval_arena.rs   | 1,341 | DONE            | eval_arena.til (1,594)       |
| ext.rs          | 1,182 | DONE            | ext.til (1,109)              |
| desugarer.rs    | 1,067 | DONE            | desugarer.til (1,750)        |
| scavenger.rs    |   642 | DONE            | scavenger.til (877)          |
| lexer.rs        |   639 | DONE            | lexer.til (734)              |
| precomp.rs      |   599 | DONE            | precomp.til (729)            |
| ufcs.rs         |   518 | DONE            | ufcs.til (700)               |
| builder.rs      |   445 | DONE            | builder.til (514)            |
| preinit.rs      |   428 | DONE            | preinit.til (466)            |
| target.rs       |   226 | DONE            | target.til (308)             |
| mode.rs         |   142 | DONE            | mode.til (148)               |
| ordered_map.rs  |   110 | DONE            | Maps to src/std/map.til      |
| arena.rs        |    60 | EQUIVALENT      | src/std/arena.til exists     |
| precomp_ext.rs  |    50 | DONE            | precomp_ext.til (45)         |
| garbager.rs     |    11 | DONE            | garbager.til (13)            |

Status: All 20 modules ported to TIL. Self-hosting is complete at the module level.

*** 2. C Runtime Support (755 lines)

Location: src/ext.c

This is the multiplatform runtime for compiled mode. There are three ext files:
- ext.c - C runtime for compiled mode (included in generated C)
- ext.til - TIL runtime for interpreted/compiled TIL
- ext.rs - Rust runtime for rstil (will be removed with Issue #100)

Functions provided:
- Printing: til_single_print, til_print_flush
- Type conversion: til_u8_to_i64, til_i64_to_u8, til_i64_to_str, til_str_to_i64
- U8 arithmetic: til_u8_add/sub/mul/div/mod/xor/and/or
- I64 arithmetic: til_i64_add/sub/mul/div/mod/xor/and/or, til_i64_lt/gt
- Memory: til_malloc, til_free, til_memcpy, til_memcmp, til_memset
- Process control: til_exit
- File I/O: til_readfile, til_writefile, til_input_read_line
- Command execution: til_run_cmd, til_spawn_cmd, til_check_cmd_status
- System: til_sleep, til_get_thread_count, til_file_mtime
- Filesystem: til_list_dir_raw, til_fs_parent_dir, til_fs_mkdir_p
- Enum support: til_enum_get_payload

ext.c is necessary and fair - these are the primitive operations that compiled TIL
programs need. The only way to reduce this is simplification, not elimination.

*** 3. Bootstrap Binary (82,034 lines)

Location: bootstrap/til.c

This is NOT hand-written C. It is the output of compiling the TIL compiler to C.
Purpose: Allow bootstrapping on systems without Rust installed.

This file should NOT count toward the "C percentage" for code quality purposes since
it's machine-generated from the TIL compiler (src/self/*.til).

** Strategies to Increase TIL Percentage

*** Strategy 1: Simplify Rust Code [HIGH IMPACT]

*Impact: Reduces Rust, TIL, and C bootstrap simultaneously*

Due to the translation chain (rstil.rs -> til.til -> til.c), simplifying the Rust
implementation directly reduces:
- The Rust codebase (23K lines)
- The TIL self-hosted port (29K lines)
- The generated C bootstrap (82K lines)

This is the primary lever for reducing non-TIL code.

Areas to simplify:
- Remove ext.rs when Issue #100 is completed
- Refactor verbose code patterns
- Eliminate dead code paths
- Simplify data structures where possible

**** Specific Opportunities Identified

**Bug #159 (in progress) - Clone/Copy Simplification:**
Consolidating clone logic from interpreter and ccodegen into garbager (AST transformation).
- Already removed: ~60 lines from ccodegen and interpreter
- Remaining: copy_fields removal for assignments, function args, struct construction
- See doc/todo/bugs.org Bug #159 for detailed progress table

**ccodegen.rs (6,800 lines):**
1. `emit_fcall` (626 lines) - Split builtins (type_as_str, enum_to_str,
   enum_get_payload, size_of, to_ptr) into separate functions
2. Declaration hoisting duplicated 3x between emit_if (then/else) and emit_while
3. `is_namespace_definition()` one-liner used 2x - could inline

**garbager.rs (142 lines):**
1. Repeated recursion pattern for FuncDef, StructDef, NamespaceDef could be unified
   - Each has: recurse default_values/body, rebuild struct with new values, recurse params
   - Could extract helper for the common pattern

**interpreter.rs:**
1. `eval_user_func_proc_call` has documented TODO REFACTOR (line 1659)
   - Replace context.clone() with scope push/pop
   - 20+ return paths need cleanup
   - Already documented with specific line numbers

**Patterns repeated 10+ times:**
- Type checking pattern: `if let Some(sym) = lookup { matches!(sym.value_type, ...) }`
- Could be helper: `is_type_variable(name, context) -> bool`

Effort: ONGOING
Impact: HIGH (affects all three codebases)

*** Strategy 2: ext.c is Necessary [NO ACTION]

ext.c provides multiplatform runtime primitives for compiled mode. This is fair and
necessary C code - it cannot be replaced with TIL because these ARE the primitives
TIL programs use (malloc, file I/O, process control, etc).

The only way to reduce ext.c is simplification, not elimination.

*** Strategy 3: Shrink bootstrap/til.c [HIGH IMPACT ON METRICS]

*Impact: Reduce the 82K line bootstrap file*

Options:

**** Option 3a: Don't count it
The most accurate approach is to exclude auto-generated files from language statistics.
Add to .gitattributes:
#+BEGIN_EXAMPLE
bootstrap/til.c linguist-generated=true
#+END_EXAMPLE

**** Option 3b: Compress the bootstrap
Current bootstrap is full debug build. A release build with:
- Dead code elimination
- Shorter generated variable names
- No debug symbols
Could be significantly smaller.

**** Option 3c: Alternative bootstrap strategy
Instead of shipping a full compiler in C, ship a minimal subset:
- Just enough to parse and interpret a "stage 1" TIL compiler
- Stage 1 compiler compiles the full compiler
This could reduce bootstrap from 82K to ~20K lines.

Effort: MEDIUM (Option 3a) to HIGH (Option 3c)
Impact: HIGH on metrics (82K lines affected)

*** Strategy 4: Expand TIL Libraries [MEDIUM IMPACT]

*Impact: Shift balance toward TIL*

Areas where more TIL library code could be written:
- Data structures: Queue, PriorityQueue, Deque
- Algorithms: Sorting, searching, graph algorithms
- Text processing: Regex, parsing utilities
- Networking: HTTP client (using run_cmd wrapper)
- Testing: More test utilities

This doesn't reduce C/Rust but increases TIL percentage.

Effort: ONGOING
Impact: MEDIUM (incremental improvement)

*** Strategy 5: TIL-based Build System [LOW IMPACT]

*Impact: Replace Makefile with TIL*

Currently make.til exists but Makefile is still used.
Could fully replace Makefile with TIL scripts.

Effort: LOW
Impact: LOW (Makefile is small)

** Recommended Action Plan

*** Phase 1: Quick Wins (done)
1. [X] Mark bootstrap/til.c as linguist-generated in .gitattributes
2. [X] Mark constfold.c as linguist-generated (example file, may go away)

*** Phase 2: Fix til Self-Compilation
Current blocker: til copies and leaks memory, preventing self-compilation.
1. [ ] Fix memory management in til compiler
2. [ ] Test rstil_til compiling itself
3. [ ] Document bootstrap process

*** Phase 3: Simplify Rust Implementation
1. [ ] Complete Issue #100 (remove ext.rs)
2. [ ] Identify verbose patterns in Rust that can be simplified
3. [ ] Port simplifications to TIL (reduces all three codebases)

** Metrics After Full Plan

Expected final state:

| Language | Lines   | Percentage | Change     |
|----------+---------+------------+------------|
| C        | ~21,000 | 25%        | -61K (-74%)|
| TIL      | ~60,000 | 71%        | +12K (+25%)|
| Rust     | ~3,000  | 4%         | -21K (-88%)|
| Total    | ~84,000 | 100%       |            |

Note: These are estimates assuming:
- bootstrap/til.c reduced to 20K via minimal bootstrap
- ext.c stays at ~750 lines (truly primitive)
- Rust reduced to minimal bootstrap glue (~3K lines)
- TIL grows with libraries and tests

** Appendix: File Inventory

*** TIL Code Distribution (48,333 lines total)

| Directory      | Lines  | Purpose                     |
|----------------+--------+-----------------------------|
| src/self/      | 29,463 | Self-hosted compiler        |
| src/test/      | ~12,000| Test suite                  |
| src/core/      | 2,100  | Core library (Vec, Str...)  |
| src/examples/  | 2,500  | Example programs            |
| src/std/       | 1,200  | Standard library            |
| src/modes/     | 110    | Mode definitions            |
| make.til       | 150    | Build system                |

*** Rust Code Distribution (23,831 lines total)

| File               | Lines | TIL Equivalent                |
|--------------------+-------+-------------------------------|
| ccodegen.rs        | 6,800 | ccodegen.til (8,557)          |
| interpreter.rs     | 2,842 | interpreter.til (3,204)       |
| typer.rs           | 2,789 | typer.til (3,594)             |
| parser.rs          | 1,866 | parser.til (2,446)            |
| init.rs            | 1,766 | init.til (2,380)              |
| eval_arena.rs      | 1,341 | eval_arena.til (1,594)        |
| ext.rs             | 1,182 | ext.til (1,109)               |
| desugarer.rs       | 1,067 | desugarer.til (1,750)         |
| scavenger.rs       | 642   | scavenger.til (877)           |
| lexer.rs           | 639   | lexer.til (734)               |
| precomp.rs         | 599   | precomp.til (729)             |
| ufcs.rs            | 518   | ufcs.til (700)                |
| builder.rs         | 445   | builder.til (514)             |
| preinit.rs         | 428   | preinit.til (466)             |
| rstil.rs           | 308   | (entry point)                 |
| target.rs          | 226   | target.til (308)              |
| mode.rs            | 142   | mode.til (148)                |
| ordered_map.rs     | 110   | DONE (src/std/map.til)        |
| arena.rs           | 60    | src/std/arena.til (55)        |
| precomp_ext.rs     | 50    | precomp_ext.til (45)          |
| garbager.rs        | 11    | garbager.til (13)             |

** Conclusion

The high C percentage is misleading because 82K of those lines are auto-generated
bootstrap code. The real picture is:

- TIL compiler is 100% self-hosted at the module level (all 20 modules ported)
- ext.c (755 lines) is necessary for multiplatform compiled mode
- bootstrap/til.c is now marked as linguist-generated
- The primary strategy to reduce code is simplifying Rust, which cascades to TIL and C

Current blocker for true self-hosting: til copies and leaks memory, preventing
self-compilation. Once fixed, Rust becomes optional for development.

Key insight: The translation chain (rstil.rs -> til.til -> til.c) means every
simplification in Rust pays off three times.
