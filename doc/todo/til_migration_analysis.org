* TIL Migration Analysis - Maximizing TIL Code Percentage

** Executive Summary

Current language distribution (by lines of code):
| Language | Lines   | Percentage | Purpose                          |
|----------+---------+------------+----------------------------------|
| C        | 82,789  | 53%        | bootstrap/til.c (82K) + ext.c    |
| TIL      | 48,333  | 31%        | Compiler, libraries, tests       |
| Rust     | 23,831  | 15%        | Bootstrap compiler (rstil)       |
| Total    | 154,953 | 100%       |                                  |

Note: The user-reported 72% C figure likely comes from GitHub linguist which may count
differently or include generated files with different weights.

Key insight: The massive C percentage comes almost entirely from bootstrap/til.c (82K
lines), which is an auto-generated file - the TIL compiler compiled to C. This is not
"real" C code but machine-generated output.

** Current Architecture

*** Compilation Pipeline
#+BEGIN_EXAMPLE
TIL Source -> [rstil (Rust)] -> C Code -> [gcc] -> Binary
                                  ^
                                  |
                              + ext.c (755 lines runtime support)
#+END_EXAMPLE

*** Self-Hosting Pipeline (in progress)
#+BEGIN_EXAMPLE
TIL Source -> [rstil_til (TIL via Rust)] -> C Code -> [gcc] -> Binary
     ^                                                          |
     |                                                          |
     +----------------------------------------------------------+
                        (self-compilation)
#+END_EXAMPLE

** Analysis by Component

*** 1. Rust Bootstrap Compiler (23,831 lines)

Location: src/rs/*.rs + src/rstil.rs

| Module          | Lines | TIL Port Status | Notes                        |
|-----------------+-------+-----------------+------------------------------|
| ccodegen.rs     | 6,800 | DONE            | ccodegen.til (8,557 lines)   |
| interpreter.rs  | 2,842 | DONE            | interpreter.til (3,204)      |
| typer.rs        | 2,789 | DONE            | typer.til (3,594)            |
| parser.rs       | 1,866 | DONE            | parser.til (2,446)           |
| init.rs         | 1,766 | DONE            | init.til (2,380)             |
| eval_arena.rs   | 1,341 | DONE            | eval_arena.til (1,594)       |
| ext.rs          | 1,182 | DONE            | ext.til (1,109)              |
| desugarer.rs    | 1,067 | DONE            | desugarer.til (1,750)        |
| scavenger.rs    |   642 | DONE            | scavenger.til (877)          |
| lexer.rs        |   639 | DONE            | lexer.til (734)              |
| precomp.rs      |   599 | DONE            | precomp.til (729)            |
| ufcs.rs         |   518 | DONE            | ufcs.til (700)               |
| builder.rs      |   445 | DONE            | builder.til (514)            |
| preinit.rs      |   428 | DONE            | preinit.til (466)            |
| target.rs       |   226 | DONE            | target.til (308)             |
| mode.rs         |   142 | DONE            | mode.til (148)               |
| ordered_map.rs  |   110 | NOT PORTED      | Simple O(n) ordered map      |
| arena.rs        |    60 | EQUIVALENT      | src/std/arena.til exists     |
| precomp_ext.rs  |    50 | DONE            | precomp_ext.til (45)         |
| garbager.rs     |    11 | DONE            | garbager.til (13)            |

Status: 18 of 20 modules ported. Only ordered_map.rs (110 lines) truly missing.

*** 2. C Runtime Support (755 lines)

Location: src/ext.c

Functions provided:
- Printing: til_single_print, til_print_flush
- Type conversion: til_u8_to_i64, til_i64_to_u8, til_i64_to_str, til_str_to_i64
- U8 arithmetic: til_u8_add/sub/mul/div/mod/xor/and/or
- I64 arithmetic: til_i64_add/sub/mul/div/mod/xor/and/or, til_i64_lt/gt
- Memory: til_malloc, til_free, til_memcpy, til_memcmp, til_memset
- Process control: til_exit
- File I/O: til_readfile, til_writefile, til_input_read_line
- Command execution: til_run_cmd, til_spawn_cmd, til_check_cmd_status
- System: til_sleep, til_get_thread_count, til_file_mtime
- Filesystem: til_list_dir_raw, til_fs_parent_dir, til_fs_mkdir_p
- Enum support: til_enum_get_payload

These are C functions that get included in generated code. They cannot be trivially
replaced with TIL because they ARE the primitive operations TIL uses.

*** 3. Bootstrap Binary (82,034 lines)

Location: bootstrap/til.c

This is NOT hand-written C. It is the output of compiling the TIL compiler to C.
Purpose: Allow bootstrapping on systems without Rust installed.

This file should NOT count toward the "C percentage" for code quality purposes since
it's machine-generated from the TIL compiler (src/self/*.til).

** Strategies to Increase TIL Percentage

*** Strategy 1: Complete Self-Hosting [HIGH IMPACT]

*Impact: Enables removal of ~23K lines of Rust*

Remaining work:
1. Port ordered_map.rs to TIL (110 lines)
   - Simple: just a Vec of (key, value) pairs with linear search
   - TIL already has src/std/map.til but it's sorted, not insertion-ordered
   - Need: OrderedMap type that preserves insertion order

2. Verify full self-compilation works
   - rstil_til should be able to compile itself completely
   - Once verified, Rust code becomes optional (kept for reference/debugging)

Effort: LOW (110 lines to port)
Impact: HIGH (23K lines of Rust become optional)

*** Strategy 2: Reduce ext.c [MEDIUM IMPACT]

*Impact: Reduce ~755 lines of required C*

The functions in ext.c fall into categories:

**** Category A: Truly primitive (CANNOT replace)
- Memory allocation (malloc, free, memcpy, memcmp, memset)
- Process control (exit, fork, exec)
- File I/O (fopen, fread, fwrite, fclose)
- These MUST be C because they're the primitives TIL uses

**** Category B: Convenience wrappers (CAN replace with TIL generating inline C)
- U8/I64 arithmetic functions
- Type conversions
- These could be inlined directly in generated C instead of calling functions

**** Category C: Complex functions (CAN partially replace)
- til_run_cmd: Complex string handling could be simplified
- til_list_dir_raw: Platform-specific but could use simpler approach

Strategy: Have ccodegen generate inline C for Category B instead of function calls.
This wouldn't reduce ext.c but would make it optional for simple programs.

Effort: MEDIUM
Impact: MEDIUM (ext.c remains but becomes more modular)

*** Strategy 3: Shrink bootstrap/til.c [HIGH IMPACT ON METRICS]

*Impact: Reduce the 82K line bootstrap file*

Options:

**** Option 3a: Don't count it
The most accurate approach is to exclude auto-generated files from language statistics.
Add to .gitattributes:
#+BEGIN_EXAMPLE
bootstrap/til.c linguist-generated=true
#+END_EXAMPLE

**** Option 3b: Compress the bootstrap
Current bootstrap is full debug build. A release build with:
- Dead code elimination
- Shorter generated variable names
- No debug symbols
Could be significantly smaller.

**** Option 3c: Alternative bootstrap strategy
Instead of shipping a full compiler in C, ship a minimal subset:
- Just enough to parse and interpret a "stage 1" TIL compiler
- Stage 1 compiler compiles the full compiler
This could reduce bootstrap from 82K to ~20K lines.

Effort: MEDIUM (Option 3a) to HIGH (Option 3c)
Impact: HIGH on metrics (82K lines affected)

*** Strategy 4: Expand TIL Libraries [MEDIUM IMPACT]

*Impact: Shift balance toward TIL*

Areas where more TIL library code could be written:
- Data structures: Queue, PriorityQueue, Deque
- Algorithms: Sorting, searching, graph algorithms
- Text processing: Regex, parsing utilities
- Networking: HTTP client (using run_cmd wrapper)
- Testing: More test utilities

This doesn't reduce C/Rust but increases TIL percentage.

Effort: ONGOING
Impact: MEDIUM (incremental improvement)

*** Strategy 5: TIL-based Build System [LOW IMPACT]

*Impact: Replace Makefile with TIL*

Currently make.til exists but Makefile is still used.
Could fully replace Makefile with TIL scripts.

Effort: LOW
Impact: LOW (Makefile is small)

** Recommended Action Plan

*** Phase 1: Quick Wins (1-2 days)
1. [X] Mark bootstrap/til.c as linguist-generated
2. [ ] Port ordered_map.rs to TIL (110 lines)
3. [ ] Verify self-compilation works end-to-end

*** Phase 2: Self-Hosting Completion (1 week)
1. [ ] Test rstil_til compiling itself
2. [ ] Document bootstrap process without Rust
3. [ ] Consider moving Rust code to separate "bootstrap" branch

*** Phase 3: Runtime Optimization (2-3 weeks)
1. [ ] Identify which ext.c functions could be inlined
2. [ ] Modify ccodegen to inline primitive operations
3. [ ] Make ext.c modular (only include what's needed)

*** Phase 4: Alternative Bootstrap (1-2 months)
1. [ ] Design minimal stage-1 interpreter in C
2. [ ] Implement stage-1 capable of running stage-2 TIL compiler
3. [ ] Replace 82K bootstrap with ~20K minimal bootstrap

** Metrics After Full Plan

Expected final state:

| Language | Lines   | Percentage | Change     |
|----------+---------+------------+------------|
| C        | ~21,000 | 25%        | -61K (-74%)|
| TIL      | ~60,000 | 71%        | +12K (+25%)|
| Rust     | ~3,000  | 4%         | -21K (-88%)|
| Total    | ~84,000 | 100%       |            |

Note: These are estimates assuming:
- bootstrap/til.c reduced to 20K via minimal bootstrap
- ext.c stays at ~750 lines (truly primitive)
- Rust reduced to minimal bootstrap glue (~3K lines)
- TIL grows with libraries and tests

** Appendix: File Inventory

*** TIL Code Distribution (48,333 lines total)

| Directory      | Lines  | Purpose                     |
|----------------+--------+-----------------------------|
| src/self/      | 29,463 | Self-hosted compiler        |
| src/test/      | ~12,000| Test suite                  |
| src/core/      | 2,100  | Core library (Vec, Str...)  |
| src/examples/  | 2,500  | Example programs            |
| src/std/       | 1,200  | Standard library            |
| src/modes/     | 110    | Mode definitions            |
| make.til       | 150    | Build system                |

*** Rust Code Distribution (23,831 lines total)

| File               | Lines | TIL Equivalent                |
|--------------------+-------+-------------------------------|
| ccodegen.rs        | 6,800 | ccodegen.til (8,557)          |
| interpreter.rs     | 2,842 | interpreter.til (3,204)       |
| typer.rs           | 2,789 | typer.til (3,594)             |
| parser.rs          | 1,866 | parser.til (2,446)            |
| init.rs            | 1,766 | init.til (2,380)              |
| eval_arena.rs      | 1,341 | eval_arena.til (1,594)        |
| ext.rs             | 1,182 | ext.til (1,109)               |
| desugarer.rs       | 1,067 | desugarer.til (1,750)         |
| scavenger.rs       | 642   | scavenger.til (877)           |
| lexer.rs           | 639   | lexer.til (734)               |
| precomp.rs         | 599   | precomp.til (729)             |
| ufcs.rs            | 518   | ufcs.til (700)                |
| builder.rs         | 445   | builder.til (514)             |
| preinit.rs         | 428   | preinit.til (466)             |
| rstil.rs           | 308   | (entry point)                 |
| target.rs          | 226   | target.til (308)              |
| mode.rs            | 142   | mode.til (148)                |
| ordered_map.rs     | 110   | NOT PORTED (need OrderedMap)  |
| arena.rs           | 60    | src/std/arena.til (55)        |
| precomp_ext.rs     | 50    | precomp_ext.til (45)          |
| garbager.rs        | 11    | garbager.til (13)             |

** Conclusion

The high C percentage is misleading because 82K of those lines are auto-generated
bootstrap code. The real picture is:

- TIL compiler is 95% self-hosted (18/20 modules ported)
- Only 110 lines of Rust truly need porting (ordered_map.rs)
- ext.c (755 lines) contains genuinely necessary C primitives
- bootstrap/til.c should be marked as generated or replaced with minimal bootstrap

Immediate recommendation: Mark bootstrap/til.c as linguist-generated and port
ordered_map.rs. This alone would show TIL at ~60% of the "real" codebase.
