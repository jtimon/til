#+TITLE: Pre-Self-Hosting TODO List
#+AUTHOR: rstil Development
#+DATE: 2025-11-10

* Overview

This document tracks TODOs in the Rust implementation (rstil) that must be completed before the self-hosted til interpreter can run successfully.

Current Status: All documented bugs fixed. Parser homogenization complete. Ready for next phase.

Scope: This focuses on rstil (Rust) implementation issues, NOT on completing the til-based interpreter/typer/etc.

* TODO Active Items

- [ ] #21 Simplify collection constructor APIs - Type identifiers as Dynamic parameters fail
  - **Current API** (verbose, redundant):
    #+BEGIN_SRC til
    mut vec := Vec.new("Str", size_of(Str))
    mut arr := Array.new("I64", size_of(I64), 10)
    mut map := Map.new("Str", size_of(Str), "I64", size_of(I64))
    mut ptr := Ptr.new("I64", size_of(I64))
    #+END_SRC
  - **Desired API** (clean, ergonomic):
    #+BEGIN_SRC til
    mut vec := Vec.new(Str)
    mut arr := Array.new(I64, 10)
    mut map := Map.new(Str, I64)
    mut ptr := Ptr.new(I64)
    #+END_SRC
  - **Blocker**: Type identifiers passed as Dynamic parameters cause "Expr index 0 out of bounds" error
  - **Root cause**: When calling type_as_str(T) or size_of(T) where T is a Dynamic parameter containing a type identifier, the function receives an empty Expr
  - **Potential solutions**: (1) Runtime type introspection functions, (2) Compile-time type parameter capture syntax, (3) Quote/unquote mechanism, (4) Keep current API
  - **Test case**: src/test/tmp/test_array_new.til reproduces the issue
  - List also needs runtime_size_of() for Dynamic parameters (separate but related issue)

- [ ] Standardize len/cap API across collections (Array has len field, Vec has len+cap fields, Map has size field, Str has len() method)
- [ ] Improve test error handling with ERROR: prefix (IN PROGRESS - dynamic_arrays.til, mut_test.til, pointers.til, and enums.til completed, other test files remain)
- [ ] Fix error line numbers from imported files (show correct file paths and line numbers)

* Completed Items

- [X] Improve forward reference error messages (added compile-time validation for undefined types, commit 7bfec12)
- [X] Improve type checking for struct type mismatches (type checking already works correctly - passing Point3D where Point2D expected produces clear compile-time error with actual struct names)

* Notes

Focus on rstil, Not til Implementation:
This tracks what the Rust interpreter (rstil) needs to support self-hosting.
Completing interpreter.til, typer.til, etc. is the GOAL of self-hosting, not prerequisites.

Workarounds Are Okay Temporarily:
Some workarounds are acceptable short-term. Priority is getting rstil stable enough to run the self-hosted code.
