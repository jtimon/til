#+TITLE: Pre-Self-Hosting TODO List
#+AUTHOR: rstil Development
#+DATE: 2025-11-12

* Overview

This document tracks TODOs in the Rust implementation (rstil) that must be completed before the self-hosted til interpreter can run successfully.

Current Status: Core language features complete. Error handling standardized. One remaining API cleanup task.

Scope: This focuses on rstil (Rust) implementation issues, NOT on completing the til-based interpreter/typer/etc.

* TODO Active Items

- [ ] Implement pass-by-reference semantics with three argument modes
  - [X] Phase 1: Type checker immutability enforcement (COMPLETE)
    - Prevents assignment to immutable parameters (typer.rs:930, 937)
    - Prevents field modification of immutable parameters (check_assignment extracts root variable)
    - Prevents passing immutable to mut parameter (typer.rs:322-344)
    - Tests in src/test/tmp/test_immutability*.til verify all cases
  - [X] Phase 2: Add 'copy' keyword for explicit copy semantics (COMPLETE)
    - Added 'copy' token to lexer (lexer.rs:25, 208, 262)
    - Added is_copy field to Declaration and SymbolInfo (parser.rs:19, init.rs:22)
    - Parser validates 'copy' and 'mut' are mutually exclusive (parser.rs:536-546)
    - Type checker allows modification of copy parameters (typer.rs:930, 937)
    - Interpreter allows assignment to copy parameters (interpreter.rs:946, 953)
    - Comprehensive tests in src/test/args.til (lines 344-467)
    - All existing tests pass
  - [X] Phase 3: Implement pass-by-reference for types without mutable fields (COMPLETE)
    - Status: COMPLETE - applies to types without mutable fields (I64, U8, Bool, etc.)
    - Implementation: Non-copy, non-own parameters share arena offsets if type has no mutable fields (zero-copy)
    - Scope: Applies to I64, U8, Bool and other types with only methods, NOT structs with mutable fields (Str, Vec, List, etc.)
    - Reason for limitation: Types with mutable fields have nested allocations incompatible with simple offset sharing
    - Benefits: Cleaner semantics, eliminates 27K+ unnecessary copies in test suite
    - All tests pass (exit code 0)
    - Performance: No significant improvement despite 27K avoided copies (~42s runtime unchanged)
      - Reason: Copying 8-byte integers is already extremely fast on modern CPUs
      - Overhead of pass-by-ref logic likely offsets copy savings for small types
    - Location: src/rs/interpreter.rs:1670-1701 (pass-by-reference logic)
  - [⏸] Phase 4: Update core library to remove Bug #24 workarounds (BLOCKED)
    - Status: BLOCKED - Phase 3 only implemented for primitives, not structs
    - Cannot remove copy-modify-reassign patterns without struct reference semantics
    - Bug #24 workarounds must remain until pass-by-reference works for structs
    - Workarounds in: List.push(), List.set(), List.pop() (src/core/core.til:1003-1009, etc.)
    - Note: Struct pass-by-reference deferred due to complex nested field allocation issues
  - Impact: Fixes Bug #24, cleaner semantics, better performance
  - See: doc/todo/plan_by_reference.org for detailed implementation plan

- [X] Standardize len/cap API across collections (COMPLETE - fixes Bug #25)
  - Renamed internal fields: len → _len, cap → cap (kept as-is for internal use)
  - Added uniform methods: len() returns element count, size() returns byte size
  - Implemented for: Vec, List, Array (lines 540-652, 957-1165, 488-545 in core.til)
  - Updated all core library files to use .len() method calls
  - Updated all test files to use .len() method calls
  - For-loop ranges: store len() result in local variable (e.g., `mut args_len := args.len()`)
  - Bug #25 FIXED: Method resolution now works correctly (e.g., `s.items.len().eq(0)`)
  - All tests pass (exit code 0)
  - Added len() and size() to Map (renamed Map.size field to Map._size to avoid conflict)
  - INCONSISTENCY: Field naming is inconsistent across types:
    - Vec, Array, List use: mut _len (with underscore prefix)
    - Map uses: mut _size (with underscore prefix, renamed from 'size')
    - Vec, Array use: mut cap (no underscore)
    - Bool, U8 use: mut data (no underscore)
    - Str uses: mut c_string, mut cap (no underscores)
  - TODO: Consider standardizing all internal fields to use _ prefix consistently
  - Reason for inconsistency: Incremental development, avoiding breaking changes

* Notes

Focus on rstil, Not til Implementation:
This tracks what the Rust interpreter (rstil) needs to support self-hosting.
Completing interpreter.til, typer.til, etc. is the GOAL of self-hosting, not prerequisites.

Workarounds Are Okay Temporarily:
Some workarounds are acceptable short-term. Priority is getting rstil stable enough to run the self-hosted code.
