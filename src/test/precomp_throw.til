mode script

// Bug #89 fix test: Functions that can throw are NOT constant-folded.
// This ensures throws happen at runtime where they can be caught.
//
// Previously, this test expected a precomp error because the throwing function
// was constant-folded. Now, functions with throws in their signature are not
// constant-folded, so the throw happens at runtime and CAN be caught.

// A pure function that always throws when called with n > 0
always_throws := func(n: I64) returns I64 throws Str {
    if gt(n, 0) {
        throw "intentional precomp error"
    }
    return 0
}

// This is NOT constant-folded because the function can throw.
// The throw happens at runtime and is caught below.
x := always_throws(5)

catch (err: Str) {
    // Bug #89 fix: We now reach this catch block because the function is
    // evaluated at runtime, not at compile time. The error is catchable!
    panic(loc(), "runtime catch: ", err)
}

panic(loc(), "should not reach here")
