mode test
import("core.i64")

// Bug #123: UFCS method calls fail on recursive nested function results
//
// Fixed: The issue was that nested function definitions were not pre-registered
// in the scope before transforming their body. Now ufcs_declaration registers
// the function BEFORE transforming its body, allowing recursive calls to resolve
// UFCS on the function's return type.

bug123_test := proc() {
    // WORKS - explicit I64.add()
    fib_explicit := func(n: I64) returns I64 {
        if lt(n, 2) {
            return n
        }
        return I64.add(fib_explicit(n.sub(1)), fib_explicit(n.sub(2)))
    }

    // Bug #123 fixed - UFCS on recursive nested function result now works
    fib_ufcs := func(n: I64) returns I64 {
        if lt(n, 2) {
            return n
        }
        return fib_ufcs(n.sub(1)).add(fib_ufcs(n.sub(2)))
    }

    test(loc(), fib_explicit(10).eq(55), "fib_explicit(10) should be 55")
    test(loc(), fib_ufcs(10).eq(55), "fib_ufcs(10) should be 55")
}

bug123_test()
