mode test
import("core.i64")

// Bug #123: UFCS method calls fail on recursive nested function results
//
// When a recursive nested function (inside a proc) calls itself and tries
// to use UFCS on the result, the C codegen doesn't wrap the function call
// result in &(til_I64){...}, causing a compilation error.
//
// Error: passing argument 1 of 'til_I64_add' makes pointer from integer without a cast
//
// Workaround: use explicit Type.method() syntax instead of UFCS.
//
// To reproduce the bug, uncomment the fib_ufcs version below.

bug123_test := proc() {
    // WORKS - explicit I64.add()
    fib_explicit := func(n: I64) returns I64 {
        if lt(n, 2) {
            return n
        }
        return I64.add(fib_explicit(n.sub(1)), fib_explicit(n.sub(2)))
    }

    // FAILS - UFCS on recursive nested function result
    // Uncomment to see the bug:
    // fib_ufcs := func(n: I64) returns I64 {
    //     if lt(n, 2) {
    //         return n
    //     }
    //     return fib_ufcs(n.sub(1)).add(fib_ufcs(n.sub(2)))
    // }

    test(loc(), fib_explicit(10).eq(55), "fib(10) should be 55")
}

bug123_test()
