mode test

import("core.vec")
import("std.list")
import("std.map")

// Test Str.clone()
test_str_clone := proc() {
    original := "hello"
    mut cloned := original.clone()

    assert_eq_str(loc(), "hello", cloned)
    assert_eq_str(loc(), "hello", original)

}
test_str_clone()

// Test Array.clone()
test_array_clone := proc() {
    mut original := Array.new(I64, 3)
    original.set(0, 10)?
    original.set(1, 20)?
    original.set(2, 30)?

    mut cloned := original.clone()

    // Check values in clone
    val0_ref := cloned.get_by_ref(0)?
    create_alias(val0, I64, val0_ref.data)
    assert_eq(loc(), 10, val0)

    val1_ref := cloned.get_by_ref(1)?
    create_alias(val1, I64, val1_ref.data)
    assert_eq(loc(), 20, val1)

    val2_ref := cloned.get_by_ref(2)?
    create_alias(val2, I64, val2_ref.data)
    assert_eq(loc(), 30, val2)

    // Modify clone, original should be unchanged
    cloned.set(0, 999)?

    orig_val_ref := original.get_by_ref(0)?
    create_alias(orig_val, I64, orig_val_ref.data)
    assert_eq(loc(), 10, orig_val)

    catch(err: IndexOutOfBoundsError) {
        println(loc(), "IndexOutOfBoundsError:", err.msg)
        exit(1)
    }
}
test_array_clone()

// Test Vec.clone()
test_vec_clone := proc() {
    mut original := Vec.new(I64)
    original.push(10)
    original.push(20)
    original.push(30)

    mut cloned := original.clone()

    assert_eq(loc(), 3, cloned.len())

    mut val0 := 0
    cloned.get(0, val0)?
    assert_eq(loc(), 10, val0)

    // Modify clone
    cloned.push(40)
    assert_eq(loc(), 4, cloned.len())
    assert_eq(loc(), 3, original.len())

    catch(err: IndexOutOfBoundsError) {
        println(loc(), "IndexOutOfBoundsError:", err.msg)
        exit(1)
    }
}
test_vec_clone()

// Test List.clone()
test_list_clone := proc() {
    mut original := List.new()
    original.push(I64, 42)?
    original.push(Str, "hello")?
    original.push(Bool, true)?

    mut cloned := original.clone()?

    assert_eq(loc(), 3, cloned.len())

    val0_ref := cloned.get_by_ref(0)?
    create_alias(val0, I64, val0_ref.data)
    assert_eq(loc(), 42, val0)

    val1_ref := cloned.get_by_ref(1)?
    create_alias(val1, Str, val1_ref.data)
    assert_eq_str(loc(), "hello", val1)

    val2_ref := cloned.get_by_ref(2)?
    create_alias(val2, Bool, val2_ref.data)
    if not(val2) {
        panic(loc(), "Expected true, got false")
    }

    // Modify clone
    cloned.push(I64, 99)?
    assert_eq(loc(), 4, cloned.len())
    assert_eq(loc(), 3, original.len())

    catch(err: IndexOutOfBoundsError) {
        println(loc(), "IndexOutOfBoundsError:", err.msg)
        exit(1)
    }
}
test_list_clone()

// Test Map.clone()
test_map_clone := proc() {
    mut original := Map.new(Str, I64)
    original.insert("one", 1)?
    original.insert("two", 2)?
    original.insert("three", 3)?

    mut cloned := original.clone()

    one_ref := cloned.get_by_ref("one")?
    create_alias(one_val, I64, one_ref.data)
    assert_eq(loc(), 1, one_val)

    two_ref := cloned.get_by_ref("two")?
    create_alias(two_val, I64, two_ref.data)
    assert_eq(loc(), 2, two_val)

    // Modify clone
    cloned.set("one", 999)

    orig_ref := original.get_by_ref("one")?
    create_alias(orig_val, I64, orig_ref.data)
    assert_eq(loc(), 1, orig_val)

    catch(err: DuplicatedKeyError) {
        println(loc(), "DuplicatedKeyError:", err.msg)
        exit(1)
    }
    catch(err: KeyNotFoundError) {
        println(loc(), "KeyNotFoundError:", err.msg)
        exit(1)
    }
}
test_map_clone()
