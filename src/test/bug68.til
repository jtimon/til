// Bug #68: Consecutive catch blocks for same error type - second goto missing
//
// Import typer and call check_types_with_context directly to reproduce the
// exact generated C code that has the bug in til.c

mode test

import("self.init")
import("self.parser")
import("self.typer")

test_bug68 := proc() {
    // Create a minimal context
    mut context := Context()
    context.path = "test.til"
    context.scope_stack.push(ScopeType.Global)

    // Create an Identifier expression for a nonexistent symbol "x"
    mut e := Expr()
    e.node_type = NodeType.Identifier("x")
    e.line = 1
    e.col = 1

    // Call check_types_with_context - this has the buggy pattern
    errors := check_types_with_context(context, e, ExprContext.ValueUsed)

    // Should get 1 error: "Undefined symbol 'x'"
    assert_eq(loc(), 1, errors.len())

    catch (err: Str) {
        panic(loc(), "unexpected Str error: ", err)
    }
}

test_bug68()
