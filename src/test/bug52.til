mode test

// Bug #52: Static buffer in ext.c til_i64_to_str caused string corruption
// When multiple to_str() calls happened before println, they all shared the
// same static buffer, so earlier values got overwritten.
// Fix: Allocate memory for each to_str() call instead of using static buffer.

import("core.vec")

// Global counter to test reading globals inside for-in loops
mut GLOBAL_COUNT := 0

// Enum with payload variant
Bug52NodeType := enum {
    Body,
    Identifier: Str,
    FCall,
}

// Struct with enum field and Vec
Bug52Expr := struct {
    mut node_type: Bug52NodeType = Bug52NodeType.Body
    mut params: Vec = Vec.new(Bug52Expr)
    mut line: I64 = 0
}

test_vec_iteration := proc() {
    mut parent := Bug52Expr()

    mut child1 := Bug52Expr(node_type=Bug52NodeType.Body, line=1)
    mut child2 := Bug52Expr(node_type=Bug52NodeType.Identifier("hello"), line=2)
    mut child3 := Bug52Expr(node_type=Bug52NodeType.FCall, line=3)

    parent.params.push(own child1)
    parent.params.push(own child2)
    parent.params.push(own child3)

    // Set global before loop
    GLOBAL_COUNT = add(GLOBAL_COUNT, 1)

    // Iterate and verify global is readable correctly inside loop
    for cursor: Bug52Expr in parent.params {
        // Bug #47: This used to read wrong value due to static buffer
        mut local_count := GLOBAL_COUNT
        assert_eq(loc(), 1, local_count)

        switch cursor.node_type {
        case Bug52NodeType.Body:
            assert_eq(loc(), 1, cursor.line)
        case Bug52NodeType.Identifier(n):
            assert_eq_str(loc(), "hello", n)
            assert_eq(loc(), 2, cursor.line)
        case Bug52NodeType.FCall:
            assert_eq(loc(), 3, cursor.line)
        case:
            panic(loc(), "Unknown Bug52NodeType variant")
        }
    }

    // Verify global wasn't corrupted
    assert_eq(loc(), 1, GLOBAL_COUNT)
}
test_vec_iteration()
