mode test

import("std.map")

// Bug #43: Map.get returns wrong value when Map is field inside struct (interpreter)
// - rstil interpret: val = 0 (WRONG)
// - rstil run: val = 42 (CORRECT)

Frame := struct {
    mut funcs: Map = Map.new(Str, I64)
}

test_map_get_in_struct := proc() {
    println("test_map_get_in_struct")

    mut frame := Frame()
    assert_eq(loc(), 0, frame.funcs._size) // Should be 0 initially
    assert_eq(loc(), 0, frame.funcs.keys._len) // Should be 0 initially
    frame.funcs.insert(own "test", own 42)?
    assert_eq(loc(), 1, frame.funcs._size) // Should be 1 after insert
    assert_eq(loc(), 1, frame.funcs.keys._len) // Should be 1 after insert

    // Try direct Map (not in struct) to isolate the issue
    mut direct_map := Map.new(Str, I64)
    direct_map.insert(own "direct_test", own 99)?
    direct_val := cast(I64, direct_map.get("direct_test")?)
    assert_eq(loc(), 99, direct_val)  // Does direct Map work?
    direct_map.delete()

    // Now try the struct field Map
    val := cast(I64, frame.funcs.get("test")?)
    assert_eq(loc(), 42, val)

    frame.funcs.delete()

    catch (err: DuplicatedKeyError) { println("DuplicatedKeyError: ", err.msg); exit(1) }
    catch (err: KeyNotFoundError) { println("KeyNotFoundError: ", err.msg); exit(1) }
}
test_map_get_in_struct()

println("All tests passed")
