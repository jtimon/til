mode test

import("std.sys")

// Test file_mtime on existing file
test_file_mtime_exists := proc() {
    // This test file itself should exist
    mtime := file_mtime("src/test/syscalls.til")
    if mtime.lt(0) {
        panic(loc(), "file_mtime returned -1 for existing file")
    }
    // Sanity check: mtime should be after year 2020 (timestamp > 1577836800)
    if mtime.lt(1577836800) {
        panic(loc(), "file_mtime returned unreasonably old timestamp")
    }
}
test_file_mtime_exists()

// Test file_mtime on non-existing file
test_file_mtime_not_exists := proc() {
    mtime := file_mtime("nonexistent_file_12345.xyz")
    neg_one := sub(0, 1)
    if not(mtime.eq(neg_one)) {
        panic(loc(), "file_mtime should return -1 for non-existing file")
    }
}
test_file_mtime_not_exists()

// Test list_dir_raw on existing directory
test_list_dir_raw_exists := proc() {
    raw := list_dir_raw("src/test")
    if raw.len().lt(1) {
        panic(loc(), "list_dir_raw returned empty for src/test which has many files")
    }
    // Check that syscalls.til is in the raw string
    if raw.find("syscalls.til").lt(0) {
        panic(loc(), "list_dir_raw did not find syscalls.til in src/test")
    }
}
test_list_dir_raw_exists()

// Test list_dir_raw on non-existing directory
test_list_dir_raw_not_exists := proc() {
    raw := list_dir_raw("nonexistent_directory_12345")
    if not(raw.len().eq(0)) {
        panic(loc(), "list_dir_raw should return empty string for non-existing directory")
    }
}
test_list_dir_raw_not_exists()

// Test run_cmd captures output correctly
test_run_cmd_output := proc() {
    mut output := ""
    exit_code := output.run_cmd("bash", "-c", "echo hello")
    if not(exit_code.eq(0)) {
        panic(loc(), "run_cmd returned non-zero exit code")
    }
    if not(output.eq("hello\n")) {
        panic(loc(), format("run_cmd output mismatch: expected 'hello\\n' (len 6), got '", output, "' (len ", output.len().to_str(), ")"))
    }
}
// test_run_cmd_output()  // TODO Bug #84: run_cmd output capture broken in compiled mode
