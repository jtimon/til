mode test

test_pointers := proc() {
    mut got_error := false
    bad_p := Ptr.new_by_size(0) // Allocating 0 or less bytes must throw AllocError
    catch (err: AllocError) {
        got_error = true
    }
    test(loc(), got_error, "Expecter AllocError when calling Ptr.new_by_size(0)")

    mut p := Ptr.new_by_size(32) // allocate 32 bytes
    test(loc(), gt(p.data, 0), "Pointer address should be non-zero")

    Ptr.set_zero(p, 32)

    mut q := Ptr.new_by_size(32)

    Ptr.copy_to(p, q, 32)

    r := Ptr.offset(p, 16)
    test(loc(), gt(r.data, p.data), "Offset pointer should be greater than base pointer")

    // s := Ptr.new2(I64) // TODO FIX

    // TODO actually free things after self hosting, when we move on from an interpreted arena (very wasteful, but feels like garbage collection for free)
    Ptr.delete(p)
    catch (err: AllocError) {
        panic(loc(), "Unexpected AllocError deleting p")
    }

    q.delete()
    catch (err: AllocError) {
        panic(loc(), "Unexpected AllocError deleting q")
    }
    // No need to free 'r', it shares memory with 'p'
}
test_pointers()
