mode test

import("std.meta")
import("std.list")
import("std.map")
import("core.vec")

// All Introspection calls use immutable bindings so precomp evaluates them
// at compile time. This avoids needing C implementations of has_const/has_field.

// has_const: associated functions (clone)
VEC_HAS_CLONE := Introspection.has_const("Vec", "clone")
STR_HAS_CLONE := Introspection.has_const("Str", "clone")
ARRAY_HAS_CLONE := Introspection.has_const("Array", "clone")
LIST_HAS_CLONE := Introspection.has_const("List", "clone")
MAP_HAS_CLONE := Introspection.has_const("Map", "clone")

// has_const: struct constants and associated functions
VEC_HAS_INIT_CAP := Introspection.has_const("Vec", "INIT_CAP")
VEC_HAS_MAX_CAP := Introspection.has_const("Vec", "MAX_CAP")
VEC_HAS_NEW := Introspection.has_const("Vec", "new")
VEC_HAS_LEN := Introspection.has_const("Vec", "len")
VEC_HAS_SIZE := Introspection.has_const("Vec", "size")

// has_const: negative cases
VEC_HAS_NONEXISTENT_CONST := Introspection.has_const("Vec", "nonexistent")
VEC_LEN_IS_CONST := Introspection.has_const("Vec", "_len")
GHOST_TYPE_HAS_CONST := Introspection.has_const("NonexistentType", "anything")

// has_field: Vec mutable fields
VEC_HAS_TYPE_NAME := Introspection.has_field("Vec", "type_name")
VEC_HAS_PTR := Introspection.has_field("Vec", "ptr")
VEC_HAS_ULEN := Introspection.has_field("Vec", "_len")
VEC_HAS_CAP := Introspection.has_field("Vec", "cap")

// has_field: Str mutable fields
STR_HAS_C_STRING := Introspection.has_field("Str", "c_string")
STR_HAS_CAP := Introspection.has_field("Str", "cap")

// has_field: negative cases
VEC_HAS_NONEXISTENT_FIELD := Introspection.has_field("Vec", "nonexistent")
VEC_CLONE_IS_FIELD := Introspection.has_field("Vec", "clone")
VEC_INIT_CAP_IS_FIELD := Introspection.has_field("Vec", "INIT_CAP")
GHOST_TYPE_HAS_FIELD := Introspection.has_field("NonexistentType", "anything")

// Test has_const - associated functions (clone)
test_has_const_clone := proc() {
    test(loc(), VEC_HAS_CLONE, "Expected Vec to have clone() const")
    test(loc(), STR_HAS_CLONE, "Expected Str to have clone() const")
    test(loc(), ARRAY_HAS_CLONE, "Expected Array to have clone() const")
    test(loc(), LIST_HAS_CLONE, "Expected List to have clone() const")
    test(loc(), MAP_HAS_CLONE, "Expected Map to have clone() const")
}
test_has_const_clone()

// Test has_const - struct constants
test_has_const_constants := proc() {
    test(loc(), VEC_HAS_INIT_CAP, "Expected Vec to have INIT_CAP const")
    test(loc(), VEC_HAS_MAX_CAP, "Expected Vec to have MAX_CAP const")
    test(loc(), VEC_HAS_NEW, "Expected Vec to have new const")
    test(loc(), VEC_HAS_LEN, "Expected Vec to have len const")
    test(loc(), VEC_HAS_SIZE, "Expected Vec to have size const")
}
test_has_const_constants()

// Test has_const - negative cases
test_has_const_negative := proc() {
    test(loc(), not(VEC_HAS_NONEXISTENT_CONST), "Expected Vec to NOT have 'nonexistent' const")
    test(loc(), not(VEC_LEN_IS_CONST), "Expected Vec._len to NOT be a const (it's mutable)")
    test(loc(), not(GHOST_TYPE_HAS_CONST), "Expected nonexistent type to return false")
}
test_has_const_negative()

// Test has_field - Vec mutable fields
test_has_field_vec := proc() {
    test(loc(), VEC_HAS_TYPE_NAME, "Expected Vec to have type_name field")
    test(loc(), VEC_HAS_PTR, "Expected Vec to have ptr field")
    test(loc(), VEC_HAS_ULEN, "Expected Vec to have _len field")
    test(loc(), VEC_HAS_CAP, "Expected Vec to have cap field")
}
test_has_field_vec()

// Test has_field - Str mutable fields
test_has_field_str := proc() {
    test(loc(), STR_HAS_C_STRING, "Expected Str to have c_string field")
    test(loc(), STR_HAS_CAP, "Expected Str to have cap field")
}
test_has_field_str()

// Test has_field - negative cases
test_has_field_negative := proc() {
    test(loc(), not(VEC_HAS_NONEXISTENT_FIELD), "Expected Vec to NOT have 'nonexistent' field")
    test(loc(), not(VEC_CLONE_IS_FIELD), "Expected Vec.clone to NOT be a field (it's a const)")
    test(loc(), not(VEC_INIT_CAP_IS_FIELD), "Expected Vec.INIT_CAP to NOT be a field (it's a const)")
    test(loc(), not(GHOST_TYPE_HAS_FIELD), "Expected nonexistent type to return false")
}
test_has_field_negative()

// Test that has_const and has_field are mutually exclusive
test_mutual_exclusion := proc() {
    // clone is a const, not a field
    test(loc(), VEC_HAS_CLONE, "Expected clone to be a const")
    test(loc(), not(VEC_CLONE_IS_FIELD), "Expected clone to NOT be a field")

    // _len is a field, not a const
    test(loc(), VEC_HAS_ULEN, "Expected _len to be a field")
    test(loc(), not(VEC_LEN_IS_CONST), "Expected _len to NOT be a const")
}
test_mutual_exclusion()
